<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link rel="icon" href="/turn.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2, #ec4899);
      min-height: 100vh;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-top: 40px;
      text-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .container {
      background: white;
      color: #333;
      width: 90%;
      max-width: 800px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin-top: 30px;
      padding: 25px;
    }
    .upload-zone {
      border: 2px dashed #999;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-zone.dragover {
      background: #eef2ff;
      border-color: #667eea;
      color: #667eea;
    }
    .file-list {
      margin-top: 20px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      gap: 15px;
    }
    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 180px;
    }
    .thumbnail {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
    }
    .progress-container {
      flex: 1;
      background: #eee;
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.2s ease;
    }
    button {
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      white-space: nowrap;
    }
    button:hover { transform: scale(1.05); }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* å–®ç¨ä¸‹è¼‰æŒ‰éˆ•çš„å°å‹æ¨£å¼ */
    .download-single-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      background: linear-gradient(90deg, #4f46e5, #3730a3);
    }
    select {
      border-radius: 8px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    footer {
      margin: 30px 0;
      text-align: center;
      opacity: 0.8;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</h1>
  <div class="container">
    <div id="uploadZone" class="upload-zone">
      æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
      <br /><br />
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
      <button id="selectBtn">é¸æ“‡åœ–ç‰‡</button>
    </div>

    <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <label>è¼¸å‡ºæ ¼å¼ï¼š</label>
      <select id="format">
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
        <option value="webp">WEBP</option>
        <option value="bmp">BMP</option>
      </select>
      <label>å“è³ªï¼š</label>
      <select id="quality">
        <option value="0.5">ä½</option>
        <option value="0.75" selected>ä¸­</option>
        <option value="1">é«˜</option>
      </select>
      <button id="convertBtn">ğŸš€ é–‹å§‹è½‰æ›</button>
      <button id="downloadAllBtn" disabled>ğŸ“¦ å…¨éƒ¨ä¸‹è¼‰</button>
    </div>

    <div class="file-list" id="fileList"></div>
  </div>

  <footer>æ‰€æœ‰è½‰æ›çš†åœ¨æœ¬åœ°é€²è¡Œï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨</footer>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const uploadZone = document.getElementById("uploadZone");
    const fileInput = document.getElementById("fileInput");
    const selectBtn = document.getElementById("selectBtn");
    const fileList = document.getElementById("fileList");
    const convertBtn = document.getElementById("convertBtn");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const formatSelect = document.getElementById("format");
    const qualitySelect = document.getElementById("quality");
    let files = [];

    selectBtn.onclick = () => fileInput.click();
    fileInput.onchange = e => addFiles(e.target.files);
    uploadZone.ondrop = e => { e.preventDefault(); uploadZone.classList.remove("dragover"); addFiles(e.dataTransfer.files); };
    uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add("dragover"); };
    uploadZone.ondragleave = () => uploadZone.classList.remove("dragover");

    function addFiles(selected) {
      for (let file of selected) {
        if (!file.type.startsWith("image/")) continue;
        const thumb = URL.createObjectURL(file);
        files.push({ file, thumb, progress: 0, convertedBlob: null, convertedName: null });
      }
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-item";
        
        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ• (åªæœ‰è½‰æ›å®Œæˆä¸”æœ‰ Blob æ™‚æ‰é¡¯ç¤º)
        const downloadBtnHtml = f.convertedBlob 
          ? `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>` 
          : `<button class="download-single-btn" style="visibility:hidden">ä¸‹è¼‰</button>`;

        div.innerHTML = `
          <div class="file-info">
            <img src="${f.thumb}" class="thumbnail">
            <div style="overflow:hidden">
              <strong style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${f.convertedName || f.file.name}</strong>
              <small>${(f.file.size/1024).toFixed(1)} KB</small>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="bar-${i}" style="width: ${f.progress}%"></div>
          </div>
          <div id="action-${i}">
            ${downloadBtnHtml}
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    convertBtn.onclick = async () => {
      if (!files.length) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
      const format = formatSelect.value;
      const quality = parseFloat(qualitySelect.value);
      
      convertBtn.disabled = true;
      downloadAllBtn.disabled = true;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        const bar = document.getElementById(`bar-${i}`);
        const actionDiv = document.getElementById(`action-${i}`);
        
        try {
          // è½‰æ›ä¸­...
          const blob = await convertImage(f.file, format, quality, p => {
            bar.style.width = `${p}%`;
          });
          
          const newName = f.file.name.replace(/\.[^.]+$/, "") + "." + format;
          f.convertedName = newName;
          f.convertedBlob = blob;
          f.progress = 100;
          bar.style.width = "100%";
          
          // æ›´æ–°è©²é …ç›®çš„ç¸®åœ–ç‚ºè½‰æ›å¾Œçš„ï¼ˆå¦‚æœæ˜¯å¾å…¶ä»–æ ¼å¼è½‰æˆ WebP ç­‰ï¼‰
          f.thumb = URL.createObjectURL(blob);
          
          // è½‰æ›å®Œæˆï¼Œç«‹å³æ›´æ–°è©²è¡Œçš„ä¸‹è¼‰æŒ‰éˆ•
          actionDiv.innerHTML = `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>`;
          
        } catch (err) {
          console.error(err);
        }
      }
      
      downloadAllBtn.disabled = false;
      convertBtn.disabled = false;
    };

    async function convertImage(file, format, quality, onProgress) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            
            // ç”±æ–¼ toBlob æ˜¯éåŒæ­¥ä½†å¾ˆå¿«ï¼Œé€™è£¡æ¨¡æ“¬ä¸€ä¸‹é€²åº¦æ¢è¦–è¦ºæ„Ÿ
            onProgress(100); 
            canvas.toBlob(blob => resolve(blob), `image/${format}`, quality);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // å–®ç¨ä¸‹è¼‰åŠŸèƒ½
    window.downloadSingle = (index) => {
      const f = files[index];
      if (!f.convertedBlob) return;
      
      const url = URL.createObjectURL(f.convertedBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = f.convertedName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // å…¨éƒ¨ä¸‹è¼‰åŠŸèƒ½
    downloadAllBtn.onclick = async () => {
      const zip = new JSZip();
      let hasFile = false;
      files.forEach(f => {
        if (f.convertedBlob) {
          zip.file(f.convertedName, f.convertedBlob);
          hasFile = true;
        }
      });
      
      if (!hasFile) return alert("æ²’æœ‰å¯ä¸‹è¼‰çš„è½‰æ›æª”æ¡ˆ");

      const blob = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "converted_images.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
