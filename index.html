<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link rel="icon" href="/turn.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…· (å«å°ºå¯¸èª¿æ•´)</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2, #ec4899);
      min-height: 100vh;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-top: 40px;
      text-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .container {
      background: white;
      color: #333;
      width: 90%;
      max-width: 850px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin-top: 30px;
      padding: 25px;
    }
    .upload-zone {
      border: 2px dashed #999;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-zone.dragover {
      background: #eef2ff;
      border-color: #667eea;
      color: #667eea;
    }
    .controls {
      margin-top:20px; 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      align-items:center;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 12px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-list {
      margin-top: 20px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      gap: 15px;
    }
    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 200px;
    }
    .thumbnail {
      width: 45px;
      height: 45px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .progress-container {
      flex: 1;
      background: #eee;
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.2s ease;
    }
    button {
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      white-space: nowrap;
    }
    button:hover { transform: scale(1.02); filter: brightness(1.1); }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .download-single-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      background: linear-gradient(90deg, #4f46e5, #3730a3);
    }
    select, input[type="number"] {
      border-radius: 6px;
      padding: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    footer {
      margin: 30px 0;
      text-align: center;
      opacity: 0.8;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</h1>
  <div class="container">
    <div id="uploadZone" class="upload-zone">
      æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
      <br /><br />
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
      <button id="selectBtn">é¸æ“‡åœ–ç‰‡</button>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>è¼¸å‡ºæ ¼å¼ï¼š</label>
        <select id="format">
          <option value="png">PNG</option>
          <option value="jpeg">JPG</option>
          <option value="webp" selected>WEBP</option>
          <option value="bmp">BMP</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>å“è³ªï¼š</label>
        <select id="quality">
          <option value="0.6">ä½</option>
          <option value="0.8" selected>ä¸­</option>
          <option value="1">é«˜</option>
        </select>
      </div>

      <div class="control-group">
        <label>èª¿æ•´å¯¬åº¦ï¼š</label>
        <input type="number" id="resizeWidth" placeholder="åŸå°ºå¯¸" style="width: 80px;">
        <small>px (ç•™ç©ºä¸ç¸®æ”¾)</small>
      </div>

      <div style="flex-grow:1; text-align:right; display:flex; gap:10px; justify-content: flex-end;">
        <button id="convertBtn">ğŸš€ é–‹å§‹è½‰æ›</button>
        <button id="downloadAllBtn" disabled>ğŸ“¦ å…¨éƒ¨ä¸‹è¼‰</button>
      </div>
    </div>

    <div class="file-list" id="fileList"></div>
  </div>

  <footer>æ‰€æœ‰è™•ç†çš†åœ¨æœ¬åœ°å®Œæˆï¼Œç¢ºä¿éš±ç§å®‰å…¨</footer>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const uploadZone = document.getElementById("uploadZone");
    const fileInput = document.getElementById("fileInput");
    const selectBtn = document.getElementById("selectBtn");
    const fileList = document.getElementById("fileList");
    const convertBtn = document.getElementById("convertBtn");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const formatSelect = document.getElementById("format");
    const qualitySelect = document.getElementById("quality");
    const resizeWidthInput = document.getElementById("resizeWidth");
    
    let files = [];

    selectBtn.onclick = () => fileInput.click();
    fileInput.onchange = e => addFiles(e.target.files);
    uploadZone.ondrop = e => { e.preventDefault(); uploadZone.classList.remove("dragover"); addFiles(e.dataTransfer.files); };
    uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add("dragover"); };
    uploadZone.ondragleave = () => uploadZone.classList.remove("dragover");

    function addFiles(selected) {
      for (let file of selected) {
        if (!file.type.startsWith("image/")) continue;
        const thumb = URL.createObjectURL(file);
        files.push({ file, thumb, progress: 0, convertedBlob: null, convertedName: null });
      }
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-item";
        const downloadBtnHtml = f.convertedBlob 
          ? `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>` 
          : `<button class="download-single-btn" style="visibility:hidden">ä¸‹è¼‰</button>`;

        div.innerHTML = `
          <div class="file-info">
            <img src="${f.thumb}" class="thumbnail">
            <div style="overflow:hidden">
              <strong style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${f.convertedName || f.file.name}</strong>
              <small>${(f.file.size/1024).toFixed(1)} KB</small>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="bar-${i}" style="width: ${f.progress}%"></div>
          </div>
          <div id="action-${i}">${downloadBtnHtml}</div>
        `;
        fileList.appendChild(div);
      });
    }

    convertBtn.onclick = async () => {
      if (!files.length) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
      const format = formatSelect.value;
      const quality = parseFloat(qualitySelect.value);
      const targetWidth = parseInt(resizeWidthInput.value);
      
      convertBtn.disabled = true;
      downloadAllBtn.disabled = true;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        const bar = document.getElementById(`bar-${i}`);
        const actionDiv = document.getElementById(`action-${i}`);
        
        try {
          const blob = await processImage(f.file, format, quality, targetWidth, p => {
            bar.style.width = `${p}%`;
          });
          
          const ext = format === 'jpeg' ? 'jpg' : format;
          const newName = f.file.name.replace(/\.[^.]+$/, "") + "." + ext;
          f.convertedName = newName;
          f.convertedBlob = blob;
          f.progress = 100;
          bar.style.width = "100%";
          f.thumb = URL.createObjectURL(blob);
          
          actionDiv.innerHTML = `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>`;
        } catch (err) {
          console.error(err);
        }
      }
      downloadAllBtn.disabled = false;
      convertBtn.disabled = false;
    };

    async function processImage(file, format, quality, targetWidth, onProgress) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            // Resize é‚è¼¯ï¼šå¦‚æœè¼¸å…¥äº†å¯¬åº¦ä¸”å°æ–¼åŸåœ–ï¼Œå‰‡ç¸®æ”¾
            if (targetWidth && targetWidth > 0) {
              const scaleFactor = targetWidth / width;
              width = targetWidth;
              height = img.height * scaleFactor;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            
            // è™•ç†å¹³æ»‘ç¸®æ”¾
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            ctx.drawImage(img, 0, 0, width, height);
            
            onProgress(100);
            const mimeType = `image/${format}`;
            canvas.toBlob(blob => resolve(blob), mimeType, quality);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    window.downloadSingle = (index) => {
      const f = files[index];
      const a = document.createElement("a");
      a.href = URL.createObjectURL(f.convertedBlob);
      a.download = f.convertedName;
      a.click();
    };

    downloadAllBtn.onclick = async () => {
      const zip = new JSZip();
      files.forEach(f => { if (f.convertedBlob) zip.file(f.convertedName, f.convertedBlob); });
      const blob = await zip.generateAsync({ type: "blob" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "images_resized.zip";
      a.click();
    };
  </script>
</body>
</html>
