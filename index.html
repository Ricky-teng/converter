<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</title>
  <style>
    body {
      margin: 0; font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2, #ec4899);
      min-height: 100vh; color: white; display: flex; flex-direction: column; align-items: center;
    }
    .container {
      background: white; color: #333; width: 90%; max-width: 850px;
      border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin-top: 30px; padding: 25px;
    }
    .upload-zone {
      border: 2px dashed #999; border-radius: 15px; padding: 40px;
      text-align: center; cursor: pointer; transition: 0.3s;
    }
    .upload-zone.dragover { background: #eef2ff; border-color: #667eea; }
    .controls {
      margin-top:20px; display:flex; gap:15px; flex-wrap:wrap; align-items:center;
      padding: 15px; background: #f3f4f6; border-radius: 12px;
    }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .file-item {
      display: flex; align-items: center; justify-content: space-between;
      background: #f9fafb; border-radius: 10px; padding: 10px 15px;
      margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); gap: 15px;
    }
    .file-info { display: flex; align-items: center; gap: 12px; min-width: 220px; }
    .thumbnail {
      width: 50px; height: 50px; object-fit: cover; border-radius: 6px;
      border: 1px solid #ddd; cursor: zoom-in; background: #eee;
    }
    .progress-container { flex: 1; background: #eee; height: 10px; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s; }
    
    button {
      background: linear-gradient(90deg, #2563eb, #1d4ed8); color: white;
      border: none; border-radius: 8px; padding: 10px 20px;
      font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .download-single-btn { padding: 8px 16px; font-size: 0.85rem; background: linear-gradient(90deg, #4f46e5, #3730a3); }

    /* Modal é è¦½ */
    #previewModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; padding: 20px;
    }
    .modal-content {
      background: white; color: #333; padding: 25px; border-radius: 15px;
      max-width: 95%; max-height: 95%; overflow-y: auto; text-align: center;
    }
    .comparison { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
    .comparison-box img { max-width: 100%; max-height: 60vh; border: 1px solid #ddd; border-radius: 8px; }
    
    select, input[type="number"] { border-radius: 6px; padding: 8px; border: 1px solid #ccc; }
    footer { margin: 30px 0; text-align: center; opacity: 0.8; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</h1>
  <div class="container">
    <div id="uploadZone" class="upload-zone">
      æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
      <br><br><button id="selectBtn">é¸æ“‡åœ–ç‰‡</button>
    </div>

    <div class="controls">
      <div class="control-group"><label>æ ¼å¼ï¼š</label><select id="format"><option value="png">PNG</option><option value="jpeg" selected>JPG</option><option value="webp">WEBP</option><option value="bmp">BMP</option></select></div>
      <div class="control-group"><label>å“è³ªï¼š</label><select id="quality"><option value="0.6">ä½</option><option value="0.8" selected>ä¸­</option><option value="1">é«˜</option></select></div>
      <div class="control-group"><label>å¯¬åº¦(px)ï¼š</label><input type="number" id="resizeWidth" placeholder="åŸå°ºå¯¸" style="width:90px"></div>
      <div style="flex-grow:1; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
        <button id="convertBtn">ğŸš€ é–‹å§‹è½‰æ›</button>
        <button id="downloadAllBtn" disabled>ğŸ“¦ å…¨éƒ¨ä¸‹è¼‰</button>
      </div>
    </div>
    <div class="file-list" id="fileList"></div>
  </div>

  <div id="previewModal">
    <div class="modal-content">
      <h3 id="previewTitle">åœ–ç‰‡é è¦½æ¯”è¼ƒ</h3>
      <div class="comparison">
        <div class="comparison-box"><p><b>åŸå§‹åœ–</b></p><img id="origImg"></div>
        <div class="comparison-box"><p><b>è½‰æª”å¾Œ</b></p><img id="convImg"></div>
      </div>
      <button onclick="closeModal()" style="background:#666">é—œé–‰é è¦½</button>
    </div>
  </div>
  <footer>é»æ“Šç¸®åœ–å³å¯é è¦½</footer>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const convertBtn = document.getElementById("convertBtn");
    let files = [];

    document.getElementById("selectBtn").onclick = () => fileInput.click();
    fileInput.onchange = e => addFiles(e.target.files);

    function addFiles(selected) {
      for (let file of selected) {
        if (!file.type.startsWith("image/")) continue;
        const url = URL.createObjectURL(file);
        files.push({ file, originalUrl: url, currentThumb: url, progress: 0, convertedBlob: null, convertedName: null });
      }
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <div class="file-info">
            <img src="${f.currentThumb}" class="thumbnail" onclick="openPreview(${i})" title="é»æ“Šé è¦½æ¯”è¼ƒ">
            <div style="overflow:hidden">
              <strong style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${f.convertedName || f.file.name}</strong>
              <small>${(f.file.size/1024).toFixed(1)} KB</small>
            </div>
          </div>
          <div class="progress-container"><div class="progress-bar" id="bar-${i}" style="width:${f.progress}%"></div></div>
          <div id="action-${i}">
            ${f.convertedBlob ? `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>` : ''}
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    convertBtn.onclick = async () => {
      if (!files.length) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
      const format = document.getElementById("format").value;
      const quality = parseFloat(document.getElementById("quality").value);
      const targetWidth = parseInt(document.getElementById("resizeWidth").value);
      
      // é˜²å‘†ï¼šå¦‚æœå¯¬åº¦å°æ–¼ 10pxï¼Œç•¶ä½œä¸èª¿æ•´å°ºå¯¸
      const finalWidth = (targetWidth > 10) ? targetWidth : null;

      convertBtn.disabled = true;

      for (let i = 0; i < files.length; i++) {
        try {
          const blob = await processImage(files[i].file, format, quality, finalWidth, p => {
            document.getElementById(`bar-${i}`).style.width = p + "%";
          });
          
          files[i].convertedBlob = blob;
          files[i].convertedName = files[i].file.name.replace(/\.[^.]+$/, "") + "." + (format === 'jpeg' ? 'jpg' : format);
          files[i].progress = 100;
          files[i].currentThumb = URL.createObjectURL(blob);
          
          // è½‰æ›å®Œä¸€å€‹ï¼Œç«‹å³æ›´æ–°è©²è¡Œ
          renderFileList();
        } catch (err) { 
          console.error(err); 
          alert("è½‰æ›å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼");
        }
      }
      downloadAllBtn.disabled = false;
      convertBtn.disabled = false;
    };

    function processImage(file, format, quality, targetWidth, onProgress) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let w = img.width, h = img.height;
            if (targetWidth) { h = (targetWidth / w) * h; w = targetWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, w, h);
            onProgress(100);
            canvas.toBlob(b => b ? resolve(b) : reject("Blob creation failed"), `image/${format}`, quality);
          };
          img.onerror = () => reject("Image load error");
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    window.openPreview = (i) => {
      const f = files[i];
      document.getElementById("origImg").src = f.originalUrl;
      document.getElementById("convImg").src = f.convertedBlob ? URL.createObjectURL(f.convertedBlob) : f.originalUrl;
      document.getElementById("previewModal").style.display = "flex";
    };

    window.closeModal = () => document.getElementById("previewModal").style.display = "none";

    window.downloadSingle = (i) => {
      const f = files[i];
      if (!f.convertedBlob) return;
      const a = document.createElement("a");
      a.href = URL.createObjectURL(f.convertedBlob);
      a.download = f.convertedName;
      a.click();
    };

    downloadAllBtn.onclick = async () => {
      const zip = new JSZip();
      let hasFile = false;
      files.forEach(f => {
        if (f.convertedBlob) {
          zip.file(f.convertedName, f.convertedBlob);
          hasFile = true;
        }
      });
      if (!hasFile) return alert("æ²’æœ‰å·²è½‰æ›çš„æª”æ¡ˆ");
      const content = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "images_export.zip";
      a.click();
    };
  </script>
</body>
</html>

