<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ–ç‰‡è½‰æª”å·¥å…· - é€²éšç‰¹æ•ˆç‰ˆ</title>
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #4f46e5;
      --danger: #ef4444;
      --success: #10b981;
    }

    body {
      margin: 0; font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2, #ec4899);
      min-height: 100vh; color: white; display: flex; flex-direction: column; align-items: center;
    }

    .container {
      background: white; color: #333; width: 90%; max-width: 850px;
      border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      margin-top: 30px; padding: 30px; transform: translateY(0); transition: 0.3s;
    }

    /* æ‹–æ”¾å€å¢å¼·ç‰¹æ•ˆ */
    .upload-zone {
      border: 2px dashed #cbd5e1; border-radius: 20px; padding: 50px;
      text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      background: #f8fafc; color: #64748b;
    }
    .upload-zone:hover { border-color: var(--primary); background: #f1f5f9; }
    .upload-zone.dragover { 
      background: #e0e7ff; border-color: var(--primary); 
      transform: scale(1.02); box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
      color: var(--primary);
    }

    .controls {
      margin-top:25px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      padding: 20px; background: #f1f5f9; border-radius: 16px;
    }

    .control-group { display: flex; align-items: center; gap: 8px; font-weight: 500; }

    /* æŒ‰éˆ•å‹•ç•«å„ªåŒ– */
    button {
      padding: 10px 22px; border: none; border-radius: 10px; font-weight: 700;
      cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    button:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
    .btn-primary:hover { filter: brightness(1.1); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4); }

    .btn-danger { background: white; color: var(--danger); border: 1.5px solid var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }

    .download-single-btn { 
      padding: 6px 14px; font-size: 0.85rem; 
      background: var(--secondary); color: white;
      animation: fadeIn 0.4s ease;
    }

    /* åˆ—è¡¨å‹•ç•« */
    .file-item {
      display: flex; align-items: center; justify-content: space-between;
      background: #f8fafc; border-radius: 12px; padding: 12px 18px;
      margin-bottom: 12px; border: 1px solid #e2e8f0; gap: 15px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .thumbnail {
      width: 55px; height: 55px; object-fit: cover; border-radius: 8px;
      cursor: zoom-in; transition: 0.2s; border: 2px solid transparent;
    }
    .thumbnail:hover { transform: scale(1.1); border-color: var(--primary); }

    .progress-container { flex: 1; background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }

    /* é è¦½ Modal */
    #previewModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.9); z-index: 1000; justify-content: center; align-items: center;
      backdrop-filter: blur(8px);
    }
    .modal-content {
      background: white; padding: 30px; border-radius: 24px; max-width: 90%; max-height: 90%;
      text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .comparison img { max-width: 100%; max-height: 55vh; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    select, input[type="number"] { border-radius: 8px; padding: 8px; border: 1px solid #cbd5e1; outline: none; }
    select:focus { border-color: var(--primary); ring: 2px var(--primary); }

    footer { margin: 40px 0; opacity: 0.7; font-size: 0.85rem; letter-spacing: 0.5px; }
  </style>
</head>
<body>

  <h1>ğŸ–¼ï¸ åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</h1>

  <div class="container">
    <div id="uploadZone" class="upload-zone">
      <div style="font-size: 3rem; margin-bottom: 10px;">â˜ï¸</div>
      <strong>æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</strong>ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
      <br><br>
      <button class="btn-primary" id="selectBtn" style="margin: 0 auto;">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</button>
    </div>

    <div class="controls">
      <div class="control-group">æ ¼å¼ <select id="format"><option value="png">PNG</option><option value="jpeg" selected>JPG</option><option value="webp">WEBP</option></select></div>
      <div class="control-group">å“è³ª <select id="quality"><option value="0.6">ä¸€èˆ¬</option><option value="0.8" selected>é«˜å“è³ª</option><option value="1">ç„¡æ</option></select></div>
      <div class="control-group">å¯¬åº¦ <input type="number" id="resizeWidth" placeholder="ä¸èª¿æ•´" style="width:80px"> px</div>
      
      <div style="flex-grow:1; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-danger" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
        <button class="btn-primary" id="convertBtn">ğŸš€ é–‹å§‹è½‰æ›</button>
        <button class="btn-primary" id="downloadAllBtn" disabled>ğŸ“¦ å…¨éƒ¨ä¸‹è¼‰</button>
      </div>
    </div>

    <div class="file-list" id="fileList"></div>
  </div>

  <div id="previewModal">
    <div class="modal-content">
      <h3 id="previewTitle" style="margin-top:0">åœ–ç‰‡é è¦½æ¯”è¼ƒ</h3>
      <div class="comparison" style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
        <div><p>åŸå§‹åœ–</p><img id="origImg"></div>
        <div><p>è½‰æª”å¾Œ</p><img id="convImg"></div>
      </div>
      <button class="btn-primary" onclick="closeModal()" style="margin: 20px auto 0; background: #64748b;">é—œé–‰è¦–çª—</button>
    </div>
  </div>

    <footer>é»æ“Šç¸®åœ–å³å¯é è¦½</footer>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const uploadZone = document.getElementById("uploadZone");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const clearBtn = document.getElementById("clearBtn");
    let files = [];

    // æ‹–æ”¾ç‰¹æ•ˆ
    uploadZone.ondragover = (e) => { e.preventDefault(); uploadZone.classList.add("dragover"); };
    uploadZone.ondragleave = () => uploadZone.classList.remove("dragover");
    uploadZone.ondrop = (e) => {
      e.preventDefault();
      uploadZone.classList.remove("dragover");
      addFiles(e.dataTransfer.files);
    };

    document.getElementById("selectBtn").onclick = () => fileInput.click();
    fileInput.onchange = e => addFiles(e.target.files);

    function addFiles(selected) {
      for (let file of selected) {
        if (!file.type.startsWith("image/")) continue;
        const url = URL.createObjectURL(file);
        files.push({ file, originalUrl: url, currentThumb: url, progress: 0, convertedBlob: null, convertedName: null });
      }
      renderFileList();
    }

    // æ¸…é™¤åŠŸèƒ½
    clearBtn.onclick = () => {
      if (files.length === 0) return;
      if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åœ–ç‰‡å—ï¼Ÿ")) {
        files.forEach(f => URL.revokeObjectURL(f.originalUrl));
        files = [];
        renderFileList();
        downloadAllBtn.disabled = true;
      }
    };

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <div class="file-info">
            <img src="${f.currentThumb}" class="thumbnail" onclick="openPreview(${i})">
            <div style="max-width: 150px; overflow: hidden;">
              <strong style="font-size:0.9rem; white-space:nowrap;">${f.convertedName || f.file.name}</strong><br>
              <small style="color: #64748b;">${(f.file.size/1024).toFixed(1)} KB</small>
            </div>
          </div>
          <div class="progress-container"><div class="progress-bar" id="bar-${i}" style="width:${f.progress}%"></div></div>
          <div id="action-${i}">
            ${f.convertedBlob ? `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>` : ''}
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    document.getElementById("convertBtn").onclick = async () => {
      if (!files.length) return;
      const format = document.getElementById("format").value;
      const quality = parseFloat(document.getElementById("quality").value);
      const targetWidth = parseInt(document.getElementById("resizeWidth").value);
      
      document.getElementById("convertBtn").disabled = true;

      for (let i = 0; i < files.length; i++) {
        if (files[i].progress === 100) continue; // è·³éå·²è½‰æª”
        const blob = await processImage(files[i].file, format, quality, targetWidth, p => {
          document.getElementById(`bar-${i}`).style.width = p + "%";
        });
        files[i].convertedBlob = blob;
        files[i].convertedName = files[i].file.name.replace(/\.[^.]+$/, "") + "." + (format === 'jpeg' ? 'jpg' : format);
        files[i].progress = 100;
        files[i].currentThumb = URL.createObjectURL(blob);
        renderFileList();
      }
      downloadAllBtn.disabled = false;
      document.getElementById("convertBtn").disabled = false;
    };

    function processImage(file, format, quality, targetWidth, onProgress) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let w = img.width, h = img.height;
            if (targetWidth > 10) { h = (targetWidth / w) * h; w = targetWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, w, h);
            onProgress(100);
            canvas.toBlob(b => resolve(b), `image/${format}`, quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    window.openPreview = i => {
      const f = files[i];
      document.getElementById("origImg").src = f.originalUrl;
      document.getElementById("convImg").src = f.convertedBlob ? URL.createObjectURL(f.convertedBlob) : f.originalUrl;
      document.getElementById("previewModal").style.display = "flex";
    };
    window.closeModal = () => document.getElementById("previewModal").style.display = "none";
    window.downloadSingle = i => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(files[i].convertedBlob);
      a.download = files[i].convertedName;
      a.click();
    };

    downloadAllBtn.onclick = async () => {
      const zip = new JSZip();
      files.forEach(f => { if(f.convertedBlob) zip.file(f.convertedName, f.convertedBlob); });
      const content = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "images_bundle.zip";
      a.click();
    };
  </script>
</body>
</html>
