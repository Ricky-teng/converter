<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link rel="icon" href="/turn.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ–ç‰‡è½‰æª”å·¥å…· (å«é è¦½æ¯”è¼ƒ)</title>
  <style>
    body {
      margin: 0; font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2, #ec4899);
      min-height: 100vh; color: white; display: flex; flex-direction: column; align-items: center;
    }
    h1 { font-size: 2.5rem; margin-top: 40px; text-shadow: 0 3px 10px rgba(0,0,0,0.3); }
    .container {
      background: white; color: #333; width: 90%; max-width: 850px;
      border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin-top: 30px; padding: 25px;
    }
    .upload-zone {
      border: 2px dashed #999; border-radius: 15px; padding: 40px;
      text-align: center; cursor: pointer; transition: 0.3s;
    }
    .upload-zone.dragover { background: #eef2ff; border-color: #667eea; }
    .controls {
      margin-top:20px; display:flex; gap:15px; flex-wrap:wrap; align-items:center;
      padding: 15px; background: #f3f4f6; border-radius: 12px;
    }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .file-item {
      display: flex; align-items: center; justify-content: space-between;
      background: #f9fafb; border-radius: 10px; padding: 10px 15px;
      margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); gap: 15px;
    }
    .file-info { display: flex; align-items: center; gap: 10px; min-width: 200px; }
    .thumbnail {
      width: 45px; height: 45px; object-fit: cover; border-radius: 6px;
      border: 1px solid #ddd; cursor: zoom-in;
    }
    .progress-container { flex: 1; background: #eee; height: 8px; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.2s; }
    
    button {
      background: linear-gradient(90deg, #2563eb, #1d4ed8); color: white;
      border: none; border-radius: 8px; padding: 10px 20px;
      font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .download-single-btn { padding: 6px 12px; font-size: 0.85rem; background: linear-gradient(90deg, #4f46e5, #3730a3); }

    /* Modal é è¦½è¦–çª—æ¨£å¼ */
    #previewModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; color: #333; padding: 20px; border-radius: 15px;
      max-width: 90%; max-height: 90%; overflow-y: auto; text-align: center;
    }
    .comparison { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
    .comparison-box { flex: 1; min-width: 300px; }
    .comparison-box img { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; }
    .close-modal { margin-top: 20px; background: #666; }

    select, input[type="number"] { border-radius: 6px; padding: 6px; border: 1px solid #ccc; }
    footer { margin: 30px 0; text-align: center; opacity: 0.8; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>ğŸ–¼ï¸ åœ–ç‰‡å¤šæ ¼å¼è½‰æª”å·¥å…·</h1>
  <div class="container">
    <div id="uploadZone" class="upload-zone">
      æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
      <br><br><button id="selectBtn">é¸æ“‡åœ–ç‰‡</button>
    </div>

    <div class="controls">
      <div class="control-group"><label>è¼¸å‡ºæ ¼å¼ï¼š</label><select id="format"><option value="png">PNG</option><option value="jpeg" selected>JPG</option><option value="webp">WEBP</option><option value="bmp">BMP</option></select></div>
      <div class="control-group"><label>å“è³ªï¼š</label><select id="quality"><option value="0.5">ä½</option><option value="0.8" selected>ä¸­</option><option value="1">é«˜</option></select></div>
      <div class="control-group"><label>èª¿æ•´å¯¬åº¦ï¼š</label><input type="number" id="resizeWidth" placeholder="åŸå°ºå¯¸" style="width:80px"> px</div>
      <div style="flex-grow:1; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
        <button id="convertBtn">ğŸš€ é–‹å§‹è½‰æ›</button>
        <button id="downloadAllBtn" disabled>ğŸ“¦ å…¨éƒ¨ä¸‹è¼‰</button>
      </div>
    </div>
    <div class="file-list" id="fileList"></div>
  </div>

  <div id="previewModal">
    <div class="modal-content">
      <h3 id="previewTitle">åœ–ç‰‡é è¦½æ¯”è¼ƒ</h3>
      <div class="comparison">
        <div class="comparison-box"><p>åŸå§‹åœ–</p><img id="origImg"></div>
        <div class="comparison-box"><p>è½‰æª”å¾Œ</p><img id="convImg"></div>
      </div>
      <button class="close-modal" onclick="closeModal()">é—œé–‰é è¦½</button>
    </div>
  </div>

  <footer>æ‰€æœ‰è™•ç†çš†åœ¨æœ¬åœ°å®Œæˆï¼Œç¢ºä¿éš±ç§å®‰å…¨</footer>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    let files = [];

    document.getElementById("selectBtn").onclick = () => fileInput.click();
    fileInput.onchange = e => addFiles(e.target.files);

    function addFiles(selected) {
      for (let file of selected) {
        if (!file.type.startsWith("image/")) continue;
        const thumb = URL.createObjectURL(file);
        files.push({ file, originalUrl: thumb, currentThumb: thumb, progress: 0, convertedBlob: null, convertedName: null });
      }
      renderFileList();
    }

    function renderFileList() {
      fileList.innerHTML = "";
      files.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <div class="file-info">
            <img src="${f.currentThumb}" class="thumbnail" onclick="openPreview(${i})">
            <div style="overflow:hidden">
              <strong style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${f.convertedName || f.file.name}</strong>
              <small>${(f.file.size/1024).toFixed(1)} KB</small>
            </div>
          </div>
          <div class="progress-container"><div class="progress-bar" id="bar-${i}" style="width:${f.progress}%"></div></div>
          <div id="action-${i}">
            ${f.convertedBlob ? `<button class="download-single-btn" onclick="downloadSingle(${i})">ä¸‹è¼‰</button>` : ''}
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    document.getElementById("convertBtn").onclick = async () => {
      if (!files.length) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
      const format = document.getElementById("format").value;
      const quality = parseFloat(document.getElementById("quality").value);
      const targetWidth = parseInt(document.getElementById("resizeWidth").value);
      
      document.getElementById("convertBtn").disabled = true;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        try {
          const blob = await processImage(f.file, format, quality, targetWidth, p => {
            document.getElementById(`bar-${i}`).style.width = p + "%";
          });
          
          f.convertedBlob = blob;
          f.convertedName = f.file.name.replace(/\.[^.]+$/, "") + "." + (format === 'jpeg' ? 'jpg' : format);
          f.progress = 100;
          f.currentThumb = URL.createObjectURL(blob);
          
          renderFileList(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
        } catch (err) { console.error(err); }
      }
      downloadAllBtn.disabled = false;
      document.getElementById("convertBtn").disabled = false;
    };

    function processImage(file, format, quality, targetWidth, onProgress) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let w = img.width, h = img.height;
            if (targetWidth > 0) { h = (targetWidth / w) * h; w = targetWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            onProgress(100);
            canvas.toBlob(blob => resolve(blob), `image/${format}`, quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    window.openPreview = (i) => {
      const f = files[i];
      document.getElementById("previewTitle").innerText = `é è¦½ï¼š${f.file.name}`;
      document.getElementById("origImg").src = f.originalUrl;
      document.getElementById("convImg").src = f.convertedBlob ? URL.createObjectURL(f.convertedBlob) : f.originalUrl;
      document.getElementById("previewModal").style.display = "flex";
    };

    window.closeModal = () => document.getElementById("previewModal").style.display = "none";

    window.downloadSingle = (i) => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(files[i].convertedBlob);
      a.download = files[i].convertedName;
      a.click();
    };

    downloadAllBtn.onclick = async () => {
      const zip = new JSZip();
      let count = 0;
      files.forEach(f => {
        if (f.convertedBlob) {
          zip.file(f.convertedName, f.convertedBlob);
          count++;
        }
      });
      if (count === 0) return alert("æ²’æœ‰å·²è½‰æ›çš„æª”æ¡ˆ");
      const content = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "converted_images.zip";
      a.click();
    };
  </script>
</body>
</html>
